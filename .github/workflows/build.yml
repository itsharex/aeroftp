name: Build AeroFTP

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

# Required permissions for creating releases
permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: linux
          - platform: windows-latest
            target: windows
          - platform: macos-latest
            target: macos

    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: Free disk space (Linux)
        if: matrix.target == 'linux'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/share/swift
          sudo apt-get clean
          df -h /

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Linux dependencies
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          # Install Snapcraft
          sudo snap install snapcraft --classic

      - name: Install npm dependencies
        run: npm ci

      - name: Run security regression suite (MVP)
        run: npm run security:regression

      # Quality gates â€” run on Linux only to avoid duplicating work across platforms
      - name: TypeScript type check
        if: matrix.target == 'linux'
        run: npx tsc --noEmit

      - name: i18n validation
        if: matrix.target == 'linux'
        run: npm run i18n:validate

      - name: Rust linting (clippy)
        if: matrix.target == 'linux'
        working-directory: src-tauri
        run: cargo clippy --all-targets -- -D warnings

      - name: Rust tests
        if: matrix.target == 'linux'
        working-directory: src-tauri
        run: cargo test

      - name: Build Tauri app
        run: npm run tauri build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Fix Tauri AppImage bug: .DirIcon is created as an absolute symlink
      # which breaks appdir-lint.sh validation on AppImageHub.
      # Re-package with a relative symlink so the AppImage is spec-compliant.
      - name: Fix AppImage DirIcon symlink
        if: matrix.target == 'linux'
        run: |
          APPIMAGE=$(realpath src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null | head -1)
          if [ -z "$APPIMAGE" ]; then echo "No AppImage found, skipping"; exit 0; fi
          echo "Fixing .DirIcon in $APPIMAGE"
          chmod +x "$APPIMAGE"
          # Extract squashfs
          OFFSET=$("$APPIMAGE" --appimage-offset)
          mkdir -p /tmp/appimage-fix
          unsquashfs -d /tmp/appimage-fix/squashfs-root -o "$OFFSET" "$APPIMAGE"
          # Replace absolute symlink with relative
          cd /tmp/appimage-fix/squashfs-root
          rm -f .DirIcon
          ICON=$(ls *.png 2>/dev/null | head -1)
          if [ -n "$ICON" ]; then
            ln -s "$ICON" .DirIcon
            echo "Fixed: .DirIcon -> $ICON (relative)"
          fi
          # Re-package
          cd /tmp/appimage-fix
          wget -q "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run squashfs-root "$APPIMAGE"
          echo "AppImage re-packaged successfully"

      # Build Snap package using Snapcraft (Tauri doesn't generate .snap)
      - name: Build Snap package
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'linux'
        uses: snapcore/action-build@3bdaa03e1ba6bf59a65f84a751d943d549a54e79 # v1
        id: snap-build

      # Upload directly to GitHub Release (only on tags)
      # Each platform uploads its own binaries - no intermediate artifacts needed
      - name: Extract changelog for release
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'linux'
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          # Extract the section between this version header and the next version header
          NOTES=$(sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | head -n -1)
          # Append download instructions
          NOTES="${NOTES}

          **Downloads:**
          - **Windows**: \`.msi\` installer or \`.exe\`
          - **macOS**: \`.dmg\` disk image
          - **Linux**: \`.deb\`, \`.rpm\`, \`.snap\`, or \`.AppImage\`"
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Linux binaries to Release
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'linux'
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          name: 'AeroFTP ${{ github.ref_name }}'
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
            ${{ steps.snap-build.outputs.snap }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Publish Snap to Snapcraft Store (only on tags)
      - name: Publish to Snap Store
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'linux'
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          SNAP_FILE="${{ steps.snap-build.outputs.snap }}"
          if [ -n "$SNAP_FILE" ] && [ -f "$SNAP_FILE" ]; then
            echo "Uploading $SNAP_FILE to Snap Store..."
            snapcraft upload --release=stable "$SNAP_FILE"
          else
            echo "Warning: Snap file not found, skipping Snap Store upload"
            echo "This is non-fatal - other packages will still be released"
          fi

      - name: Upload Windows binaries to Release
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'windows'
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS binaries to Release
        if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'macos'
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          files: |
            src-tauri/target/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
