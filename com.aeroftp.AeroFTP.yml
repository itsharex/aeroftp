app-id: com.aeroftp.AeroFTP
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node20
command: aeroftp

finish-args:
  # Network access for FTP/FTPS connections
  - --share=network
  
  # Full home directory access (required for FTP client to access user files)
  - --filesystem=home
  
  # Access to removable media for FTP transfers
  - --filesystem=/media
  - --filesystem=/run/media
  
  # Wayland and X11 GUI support
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  
  # GPU acceleration for WebKitGTK
  - --device=dri
  
  # Audio support for media player feature
  - --socket=pulseaudio
  
  # D-Bus for secrets (saved passwords) and system tray
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.indicator.application
  - --talk-name=org.ayatana.indicator.application

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node20/bin

modules:
  # Shared module for libappindicator (system tray support)
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json

  # WebKitGTK 4.0 for Tauri (soup2 required)
  - name: webkit2gtk-4.0
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_DOCUMENTATION=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_MINIBROWSER=OFF
      - -DENABLE_SPEECH_SYNTHESIS=OFF
      - -DENABLE_WEBDRIVER=OFF
      - -DPORT=GTK
      - -DUSE_GTK4=OFF
      - -DUSE_LIBBACKTRACE=OFF
      - -DUSE_SOUP2=ON
    modules:
      - shared-modules/libsoup/libsoup-2.4.json
      
      - name: unifdef
        no-autogen: true
        make-install-args:
          - prefix=${FLATPAK_DEST}
        sources:
          - type: archive
            url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
            sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        cleanup:
          - '*'
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.48.5.tar.xz
        sha256: bb64ed9d1cfd58e8b5e89ccad71dd31adfed56336bad7695031ad0b668e1987c

  # AeroFTP - build from source
  - name: aeroftp
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/aeroftp/cargo
        XDG_CACHE_HOME: /run/build/aeroftp/flatpak-node/cache
        npm_config_cache: /run/build/aeroftp/flatpak-node/npm-cache
        npm_config_offline: 'true'
        NODE_OPTIONS: --max_old_space_size=4096
    build-commands:
      # Install npm dependencies offline
      - npm ci --offline --legacy-peer-deps
      
      # Fetch Rust dependencies offline
      - cargo --offline fetch --manifest-path src-tauri/Cargo.toml
      
      # Build the Tauri application
      - npm run tauri build -- -b none
      
      # Install binary
      - install -Dm755 src-tauri/target/release/aeroftp /app/bin/aeroftp
      
      # Install icons at multiple sizes
      - install -Dm644 src-tauri/icons/32x32.png /app/share/icons/hicolor/32x32/apps/com.aeroftp.AeroFTP.png
      - install -Dm644 src-tauri/icons/128x128.png /app/share/icons/hicolor/128x128/apps/com.aeroftp.AeroFTP.png
      - install -Dm644 icons/AeroFTP_simbol_color_512x512.png /app/share/icons/hicolor/512x512/apps/com.aeroftp.AeroFTP.png
      
      # Install desktop file
      - install -Dm644 com.aeroftp.AeroFTP.desktop /app/share/applications/com.aeroftp.AeroFTP.desktop
      
      # Install AppStream metadata
      - install -Dm644 com.aeroftp.AeroFTP.metainfo.xml /app/share/metainfo/com.aeroftp.AeroFTP.metainfo.xml
    
    sources:
      # Source code from tagged release
      - type: git
        url: https://github.com/axpnet/aeroftp.git
        tag: v2.6.10
      
      # Node.js dependencies (generated by flatpak-node-generator)
      - node-sources.json
      
      # Rust/Cargo dependencies (generated by flatpak-cargo-generator)
      - cargo-sources.json
