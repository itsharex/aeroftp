app-id: com.aeroftp.app
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: aeroftp

finish-args:
  # Network access for FTP/FTPS connections
  - --share=network
  
  # Full home directory access (required for FTP client to access user files)
  - --filesystem=home
  
  # Access to removable media for FTP transfers
  - --filesystem=/media
  - --filesystem=/run/media
  
  # Additional filesystem access via portal fallback
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  
  # Wayland and X11 GUI support
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  
  # GPU acceleration for WebKitGTK
  - --device=dri
  
  # Audio support for media player feature
  - --socket=pulseaudio
  
  # D-Bus for secrets (saved passwords) and system tray
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.indicator.application
  - --talk-name=org.ayatana.indicator.application
  
  # File chooser portal for additional file access
  - --talk-name=org.freedesktop.portal.FileChooser

build-options:
  # Fix lib64 vs lib issue
  env:
    PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/lib64/pkgconfig:/app/share/pkgconfig
    LD_LIBRARY_PATH: /app/lib:/app/lib64

modules:
  # intltool required by libdbusmenu
  - shared-modules/intltool/intltool-0.51.json

  # libdbusmenu for menu support
  - name: libdbusmenu
    buildsystem: autotools
    build-options:
      cflags: -Wno-error
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/lib64/pkgconfig:/app/share/pkgconfig
    config-opts:
      - --with-gtk=3
      - --disable-dumper
      - --disable-static
      - --disable-tests
      - --disable-gtk-doc
      - --enable-introspection=no
      - --disable-vala
    sources:
      - type: archive
        url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
        sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a
      - type: patch
        path: shared-modules/libayatana-appindicator/0001-Fix-HAVE_VALGRIND-AM_CONDITIONAL.patch

  # ayatana-ido for indicator widgets
  - name: ayatana-ido
    buildsystem: cmake-ninja
    build-options:
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/lib64/pkgconfig:/app/share/pkgconfig
    config-opts:
      - -DENABLE_INTROSPECTION=OFF
      - -DCMAKE_INSTALL_LIBDIR=lib
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/ayatana-ido.git
        tag: 0.10.4
      - type: patch
        path: shared-modules/libayatana-appindicator/0001-Make-introspection-configurable.patch

  # libayatana-indicator
  - name: libayatana-indicator
    buildsystem: cmake-ninja
    build-options:
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/lib64/pkgconfig:/app/share/pkgconfig
    config-opts:
      - -DENABLE_TESTS=OFF
      - -DENABLE_IDO=ON
      - -DCMAKE_INSTALL_LIBDIR=lib
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-indicator.git
        tag: 0.9.4

  # libayatana-appindicator for system tray
  - name: libayatana-appindicator
    buildsystem: cmake-ninja
    build-options:
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/lib64/pkgconfig:/app/share/pkgconfig
    config-opts:
      - -DENABLE_BINDINGS_MONO=OFF
      - -DENABLE_BINDINGS_VALA=OFF
      - -DENABLE_GTKDOC=OFF
      - -DCMAKE_INSTALL_LIBDIR=lib
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-appindicator.git
        tag: 0.5.94

  # AeroFTP application - extract from .deb package
  - name: aeroftp
    buildsystem: simple
    build-commands:
      # Extract deb package
      - ar x aeroftp.deb
      - tar xf data.tar.gz
      
      # Install binary
      - install -Dm755 usr/bin/aeroftp /app/bin/aeroftp
      
      # Install icons at multiple sizes
      - install -Dm644 usr/share/icons/hicolor/32x32/apps/aeroftp.png /app/share/icons/hicolor/32x32/apps/com.aeroftp.app.png
      - install -Dm644 usr/share/icons/hicolor/128x128/apps/aeroftp.png /app/share/icons/hicolor/128x128/apps/com.aeroftp.app.png
      - install -Dm644 usr/share/icons/hicolor/256x256@2/apps/aeroftp.png /app/share/icons/hicolor/256x256/apps/com.aeroftp.app.png || true
      - install -Dm644 icon512.png /app/share/icons/hicolor/512x512/apps/com.aeroftp.app.png
      
      # Install desktop file
      - install -Dm644 com.aeroftp.app.desktop /app/share/applications/com.aeroftp.app.desktop
      
      # Install AppStream metadata
      - install -Dm644 com.aeroftp.app.metainfo.xml /app/share/metainfo/com.aeroftp.app.metainfo.xml
    
    sources:
      # .deb package from GitHub Release v0.9.6
      - type: file
        url: https://github.com/axpnet/aeroftp/releases/download/v0.9.6/AeroFTP_0.9.6_amd64.deb
        sha256: f8694fe385cd19c4b0dcc61ece731c8d35f4ce7069aa08e02bf1c63d1c8fa938
        dest-filename: aeroftp.deb
      
      # 512x512 icon from repository
      - type: file
        url: https://raw.githubusercontent.com/axpnet/aeroftp/main/icons/AeroFTP_simbol_color_512x512.png
        sha256: 95e76a7d291ff486f4d3554d52ef1d9d69bf0718c44e636ddaa41eeaa126a302
        dest-filename: icon512.png
      
      # Desktop file
      - type: file
        path: com.aeroftp.app.desktop
      
      # AppStream metadata
      - type: file
        path: com.aeroftp.app.metainfo.xml
